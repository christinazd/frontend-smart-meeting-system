<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no" />
  <title>Admin Panel — Smart Meeting System</title>

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

  <link rel="stylesheet" href="css/style.css">

  <link rel="stylesheet" href="css/admin.css">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
</head>
<body class="bg-white">
<header class="navigation fixed-top">
  <div class="container">
    <header class="navigation fixed-top">
    <div class="container">
      <nav class="navbar navbar-expand-lg navbar-light px-0">
        <a class="navbar-brand logo" href="index.html">
          <img loading="lazy" class="logo-default" src="images/l1.png" alt="logo" height="60" width="60" />

        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navigation"
          aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navigation">
          <ul class="navbar-nav ml-auto text-center">
            <li class="nav-item"><a class="nav-link" href="index.html">Homepage</a></li>
            <li class="nav-item"><a class="nav-link" href="about.html">About Us</a></li>
            <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
            <li class="nav-item"><a class="nav-link" href="admin.html">Admin Panel</a></li>
            <li class="nav-item"><a class="nav-link" href="schedule.html">Schedule</a></li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#!" id="navbarDropdown02" role="button" data-toggle="dropdown"
                 aria-haspopup="true" aria-expanded="false">
                Booking <i class="tf-ion-chevron-down"></i>
              </a>
              <ul class="dropdown-menu" aria-labelledby="navbarDropdown02">
                <li><a class="dropdown-item" href="meetingroombooking.html">Meeting Room Booking</a></li>
                <li><a class="dropdown-item" href="activemeetingsreen.html">Active Meeting Screen</a></li>
                <li><a class="dropdown-item" href="mom.html">Minutes of Meeting</a></li>
              </ul>
            </li>
            <li class="nav-item" id="logoutBTn">
              <a class="nav-link" href="login.html">Logout</a>
            </li>
          </ul>
        </div>
      </nav>
    </div>
  </header>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const loginLogoutNav = document.getElementById("loginLogoutNav");
      const isLoggedIn = localStorage.getItem("loggedIn") === "true";
      if (isLoggedIn) {
        loginLogoutNav.innerHTML = `<a class="nav-link" href="#" id="logoutBtn">Logout</a>`;
        document.getElementById("logoutBtn").addEventListener("click", function (e) {
          e.preventDefault();
          localStorage.removeItem("loggedIn");
          window.location.href = "index.html";
        });
      } else {
        loginLogoutNav.innerHTML = `<a class="nav-link" href="login.html">Login</a>`;
      }
    });
  </script>
    </div>
</header>
<style>
    body {
      background-color: #ffffff; /* White page background */
      padding-top: 80px; /* Prevent overlap with navbar */
    }
    .navbar {
       position: fixed;      /* Stays in place */
    top: 0;
    left: 0;
    width: 100%;          /* Full width */
            /* Covers the whole page height */
    background-color: #078992; /* Your navbar color */
    z-index: -1;

    }
    .card {
      border-radius: 12px;
      box-shadow: 0px 4px 12px rgba(0,0,0,0.1);
    }
    .card-header {
      background-color: #f8f9fa;
      font-weight: bold;
    }
    .button-alter{
      display:flex;
      justify-content: center;
      gap:5px;
      flex-wrap: nowrap;
    }
  </style>
  <style>
  body {
    background-color: #ffffff;
    padding-top: 80px; /* ✅ Added spacing so content doesn't overlap navbar */
  }
</style>
  <main class="container py-4">
    <div class="d-flex align-items-center justify-content-between mb-4">
      <div>
        <h1 class="mb-1">Admin Panel</h1>
        <p class="text-muted mb-0">Ultimate control center — users, rooms, meetings, analytics.</p>
      </div>
      <div class="d-flex align-items-center">
        <button id="exportBtn" class="btn btn-outline-secondary mr-2"><i class="fas fa-file-export"></i> Export</button>
        <button id="openAddUser" class="btn btn-primary" data-toggle="modal" data-target="#modalAddUser"><i class="fas fa-user-plus"></i> Add User</button>
      </div>
    </div>

    <div class="row mb-4">
      <div class="col-md-3 mb-3">
        <div class="stat-card glass p-3">
          <div class="d-flex align-items-center">
            <div class="mr-3 stat-icon bg-indigo"><i class="fas fa-calendar-alt"></i></div>
            <div>
              <div class="text-muted small">Upcoming Meetings</div>
              <div class="h3 mb-0" id="stat-meetings">—</div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-3 mb-3">
        <div class="stat-card glass p-3">
          <div class="d-flex align-items-center">
            <div class="mr-3 stat-icon bg-teal"><i class="fas fa-door-open"></i></div>
            <div>
              <div class="text-muted small">Rooms Available</div>
              <div class="h3 mb-0" id="stat-rooms">—</div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-3 mb-3">
        <div class="stat-card glass p-3">
          <div class="d-flex align-items-center">
            <div class="mr-3 stat-icon bg-warning"><i class="fas fa-bell"></i></div>
            <div>
              <div class="text-muted small">Notifications</div>
              <div class="h3 mb-0" id="stat-notifs">—</div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-3 mb-3">
        <div class="stat-card glass p-3">
          <div class="d-flex align-items-center">
            <div class="mr-3 stat-icon bg-purple"><i class="fas fa-chart-pie"></i></div>
            <div>
              <div class="text-muted small">Usage %</div>
              <div class="h3 mb-0" id="stat-usage">—</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-lg-8">
        <div class="card card-quiet mb-4">
          <div class="card-body d-flex flex-wrap align-items-center">
            <button id="btn-schedule" class="btn btn-outline-primary qa-btn mr-3 mb-2"><i class="fas fa-calendar-plus"></i> Schedule Meeting</button>
            <button id="btn-join" class="btn btn-success qa-btn mr-3 mb-2"><i class="fas fa-video"></i> Join Now</button>
            <button id="btn-minutes" class="btn btn-info qa-btn mr-3 mb-2"><i class="fas fa-file-alt"></i> View Minutes</button>
            <div class="ml-auto text-right">
              <small class="text-muted d-block">System Health</small>
              <div class="progress" style="height:8px; width:240px;">
                <div id="healthBar" class="progress-bar bg-success" role="progressbar" style="width:95%"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="card card-quiet mb-4">
          <div class="card-header d-flex align-items-center justify-content-between">
            <h5 class="mb-0">Room Availability (Today)</h5>
            <small class="text-muted">Click a free slot to quick-book</small>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table mb-0 room-table">
                <thead class="thead-light">
                  <tr>
                    <th>Room</th>
                    <th class="text-center">9:00</th>
                    <th class="text-center">10:00</th>
                    <th class="text-center">11:00</th>
                    <th class="text-center">12:00</th>
                    <th class="text-center">13:00</th>
                    <th class="text-center">14:00</th>
                    <th class="text-center">15:00</th>
                  </tr>
                </thead>
                <tbody id="roomTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card card-quiet mb-4">
            <div class="card-header d-flex align-items-center justify-content-between">
                <h5 class="mb-0">User Management</h5>
                <button id="openAddUser" class="btn btn-sm btn-primary" data-toggle="modal" data-target="#modalAddUser">
                    <i class="fas fa-plus"></i> Add User
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="thead-light">
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th class="text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="userListTable">
                            <tr><td colspan="4" class="text-center text-muted">Loading users...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card card-quiet mb-4">
          <div class="card-header d-flex align-items-center justify-content-between">
            <h5 class="mb-0">Room Management</h5>
            <button id="openAddRoom" class="btn btn-sm btn-primary" data-toggle="modal" data-target="#modalAddRoom"><i class="fas fa-plus"></i> Add Room</button>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="thead-light">
                  <tr>
                    <th>Room Name</th>
                    <th>Location</th>
                    <th>Capacity</th>
                    <th>Features</th>
                    <th class="text-right">Actions</th>
                  </tr>
                </thead>
                <tbody id="roomsList"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      

      <div class="col-lg-4">
        <div class="card card-quiet mb-4">
          <div class="card-header"><h6 class="mb-0">System Alerts</h6></div>
          <div class="card-body" id="alertsList"></div>
        </div>

        <div class="card card-quiet mb-4">
          <div class="card-header"><h6 class="mb-0">Room Usage Analytics</h6></div>
          <div class="card-body">
            <canvas id="usageChart" height="160"></canvas>
          </div>
        </div>

        <div class="card card-quiet">
          <div class="card-header"><h6 class="mb-0">Recent Activity</h6></div>
          <div class="card-body" id="activityList"></div>
        </div>
      </div>
    </div>
  </main>

  <div class="modal fade" id="modalRoom" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-md" role="document">
      <form id="formRoom" class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Add / Edit Room</h5><button type="button" class="close" data-dismiss="modal">&times;</button></div>
        <div class="modal-body">
          <input type="hidden" id="roomId">
          <div class="form-group">
            <label for="roomName">Room Name</label>
            <input id="roomName" class="form-control" required placeholder="e.g. Conference Room A">
          </div>
          <div class="form-row">
            <div class="form-group col-sm-6">
              <label>Capacity</label>
              <input id="roomCapacity" type="number" min="1" class="form-control" required>
            </div>
            
          </div>
          <div class="form-group">
            <label>Features</label>
            <div class="form-check">
              <input id="eqMic" class="form-check-input" type="checkbox">
              <label class="form-check-label" for="eqMic">Microphone</label>
            </div>
            <div class="form-check">
              <input id="eqProjector" class="form-check-input" type="checkbox">
              <label class="form-check-label" for="eqProjector">Projector</label>
            </div>
          </div>
        </div>
        <div class="modal-footer"><button class="btn btn-primary" type="submit">Save Room</button><button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button></div>
      </form>
    </div>
  </div>

  <div class="modal fade" id="modalSchedule" tabindex="-1"><div class="modal-dialog"><form id="formSchedule" class="modal-content"><div class="modal-header"><h5 class="modal-title">Schedule Meeting</h5><button type="button" class="close" data-dismiss="modal">&times;</button></div><div class="modal-body">
    <div class="form-group"><label>Title</label><input id="schedTitle" class="form-control" required></div>
    <div class="form-row"><div class="form-group col-sm-6"><label>Date</label><input id="schedDate" type="date" class="form-control" required></div><div class="form-group col-sm-6"><label>Time</label><input id="schedTime" type="time" class="form-control" required></div></div>
    <div class="form-group"><label>Room</label><select id="schedRoom" class="form-control"></select></div>
  </div><div class="modal-footer"><button class="btn btn-primary" type="submit">Save</button><button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button></div></form></div></div>

  <div class="modal fade" id="modalAddUser" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-md" role="document">
      <form id="formAddUser" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add New User</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="userName">Full Name</label>
            <input type="text" class="form-control" id="userName" placeholder="Enter full name" required>
          </div>
          <div class="form-group">
            <label for="userEmail">Email address</label>
            <input type="email" class="form-control" id="userEmail" placeholder="Enter email" required>
          </div>
          <div class="form-group">
            <label for="userPassword">Password</label>
            <input type="password" class="form-control" id="userPassword" placeholder="Enter password" required>
          </div>
          <div class="form-group">
            <label for="userRole">Role</label>
            <select class="form-control" id="userRole" required>
              <option value="">Select role</option>
              <option value="admin">Admin</option>
              <option value="employee">Employee</option>
            </select>
          </div>
          <input type="hidden" id="tokenField" name="api_token" />
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add User</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal fade" id="modalAddRoom" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-md" role="document">
      <form id="formAddRoom" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add New Room</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="roomNameInput">Room Name</label>
            <input type="text" class="form-control" id="roomNameInput" placeholder="Enter room name" required>
          </div>
          <div class="form-group">
            <label for="roomLocation">Location</label>
            <input type="text" class="form-control" id="roomLocation" placeholder="Enter location" required>
          </div>
          <div class="form-group">
            <label for="roomCapacityInput">Capacity</label>
            <input type="number" class="form-control" id="roomCapacityInput" min="1" placeholder="Enter capacity" required>
          </div>
          <div class="form-group">
            <label>Features</label>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="featureProjector">
              <label class="form-check-label" for="featureProjector">Projector</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="featureWhiteboard">
              <label class="form-check-label" for="featureWhiteboard">Whiteboard</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="featureConference">
              <label class="form-check-label" for="featureConference">Video Conferencing</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="featureWifi">
              <label class="form-check-label" for="featureWifi">High-speed WiFi</label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Room</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal fade" id="modalUpdateUser" tabindex="-1" role="dialog" aria-labelledby="updateUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-md" role="document">
      <form id="formUpdateUser" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="updateUserModalLabel">Update User</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="userUpdateId" name="id" />
          <div class="form-group">
            <label for="userUpdateName">Full Name</label>
            <input type="text" class="form-control" id="userUpdateName" placeholder="Enter full name" required>
          </div>
          <div class="form-group">
            <label for="userUpdateEmail">Email address</label>
            <input type="email" class="form-control" id="userUpdateEmail" placeholder="Enter email" required>
          </div>
          <div class="form-group">
            <label for="userUpdateRole">Role</label>
            <select class="form-control" id="userUpdateRole" required>
              <option value="">Select role</option>
              <option value="admin">Admin</option>
              <option value="employee">Employee</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
</div>

<div class="modal fade" id="modalUpdateRoom" tabindex="-1" role="dialog" aria-labelledby="updateRoomModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-md" role="document">
        <form id="formUpdateRoom" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateRoomModalLabel">Update Room</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="roomUpdateId" name="id" />
                <div class="form-group">
                    <label for="roomUpdateName">Room Name</label>
                    <input type="text" class="form-control" id="roomUpdateName" required>
                </div>
                <div class="form-group">
                    <label for="roomUpdateLocation">Location</label>
                    <input type="text" class="form-control" id="roomUpdateLocation" required>
                </div>
                <div class="form-group">
                    <label for="roomUpdateCapacity">Capacity</label>
                    <input type="number" class="form-control" id="roomUpdateCapacity" min="1" required>
                </div>
                <div class="form-group">
                    <label>Features</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="featureUpdateProjector">
                        <label class="form-check-label" for="featureUpdateProjector">Projector</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="featureUpdateWhiteboard">
                        <label class="form-check-label" for="featureUpdateWhiteboard">Whiteboard</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="featureUpdateConference">
                        <label class="form-check-label" for="featureUpdateConference">Video Conferencing</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="featureUpdateWifi">
                        <label class="form-check-label" for="featureUpdateWifi">High-speed WiFi</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
        </form>
    </div>
</div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

  <script src="js/role-visibility.js"></script>
  <script src="js/sms-admin-premium.js"></script>
   <script src="js/role-visibility.js"></script>
     <script>
    document.addEventListener("DOMContentLoaded", function() {
      // User form submission

      const userForm= document.getElementById('formAddUser');
      userForm.addEventListener('submit', function(e) {

        e.preventDefault();

        const token = localStorage.getItem('token');
        if (!token) {
          alert("Authentication error. Please log in again.");
          return;
        }

        const payload = new FormData(this);
        payload.set('name', document.getElementById('userName').value);
        payload.set('email', document.getElementById('userEmail').value);
        payload.set('password', document.getElementById('userPassword').value);
        payload.set('role', document.getElementById('userRole').value);


        fetch('http://127.0.0.1:8000/api/users', {
          method: 'POST',
          body: payload,
          headers: {
            'Authorization': `Bearer ${token}`, 
          },  

        })
        .then(res => res.json())
        .then(data => {
          console.log(data);
          alert('User added successfully!');
          $('#modalAddUser').modal('hide');
          this.reset();
          fetchUsers();
        })
        .catch(err => {
          console.error(err);
          alert('Failed to add user. Check the console for details.');
        });
      });
     
      // Room form submission
    document.getElementById('formAddRoom').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const token = localStorage.getItem('token');
    if (!token) {
        alert("Authentication error. Please log in again.");
        return;
    }

    const payload = {
        name: document.getElementById('roomNameInput').value,
        location: document.getElementById('roomLocation').value,
        capacity: document.getElementById('roomCapacityInput').value,
        features: {
            'Projector': document.getElementById('featureProjector').checked,
            'Whiteboard': document.getElementById('featureWhiteboard').checked,
            'Video Conferencing': document.getElementById('featureConference').checked,
            'High-speed WiFi': document.getElementById('featureWifi').checked,
        },
    };

    fetch('http://127.0.0.1:8000/api/rooms', {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
    })
    .then(res => {
        if (!res.ok) {
            return res.json().then(errorData => {
                throw new Error(errorData.message || 'Failed to add room.');
            });
        }
        return res.json();
    })
    .then(data => {
        alert('Room added successfully!');
        $('#modalAddRoom').modal('hide');
        this.reset();
        fetchRooms();
    })
    .catch(err => {
        console.error('Error adding room:', err);
        alert('Failed to add room. Check the console for details.');
    });
});
    });
  </script>

  <script>
    const API_BASE = "http://127.0.0.1:8000/api";
    const userListTable = document.getElementById('userListTable');
    const roomsList = document.getElementById('roomsList');


    // --- USER MANAGEMENT FUNCTIONS ---
    async function fetchUsers() {
        const token = localStorage.getItem('token');
        if (!token) {
            userListTable.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Authentication token not found. Please log in.</td></tr>';
            return;
        }

        try {
            const response = await fetch(API_BASE + '/users', {
                headers: { 
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/json'
                }
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: 'No JSON response' }));
                userListTable.innerHTML = `<tr><td colspan="4" class="text-center text-danger">Failed to load users: ${errorData.message}</td></tr>`;
                return;
            }

            const data = await response.json();
            userListTable.innerHTML = '';
            
            if (!data || !data.data || !Array.isArray(data.data)) {
                 userListTable.innerHTML = `<tr><td colspan="4" class="text-center text-danger">Unexpected data format from API.</td></tr>`;
                 return;
            }
            data.data.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td>${user.role}</td>
                    <td class="text-right">
                        <button class="btn btn-sm btn-info edit-btn" data-id="${user.id}"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger delete-btn" data-id="${user.id}"><i class="fas fa-trash-alt"></i></button>
                    </td>
                `;
                userListTable.appendChild(row);
            });
        } catch (error) {
            console.error('An error occurred during the fetch operation:', error);
            userListTable.innerHTML = '<tr><td colspan="4" class="text-center text-danger">A network error occurred. Is the server running?</td></tr>';
        }
    }
    
    async function deleteUser(userId) {
        const token = localStorage.getItem('token');
        if (!confirm('Are you sure you want to delete this user?')) return;
        
        try {
            const response = await fetch(`${API_BASE}/users/${userId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                alert('User deleted successfully!');
                fetchUsers();
            } else {
                throw new Error('Failed to delete user.');
            }
        } catch (error) {
            console.error('Delete error:', error);
            alert('Failed to delete user.');
        }
    }

    userListTable.addEventListener('click', async (e) => {
        if (e.target.closest('.delete-btn')) {
            const userId = e.target.closest('.delete-btn').getAttribute('data-id');
            deleteUser(userId);
        } else if (e.target.closest('.edit-btn')) {
            const userId = e.target.closest('.edit-btn').getAttribute('data-id');
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`${API_BASE}/users/${userId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) {
                    throw new Error('Failed to fetch user data for update.');
                }
                const userData = await response.json();
                
                document.getElementById('userUpdateId').value = userData.data.id;
                document.getElementById('userUpdateName').value = userData.data.name;
                document.getElementById('userUpdateEmail').value = userData.data.email;
                document.getElementById('userUpdateRole').value = userData.data.role;
                $('#modalUpdateUser').modal('show');
            } catch (error) {
                console.error('Failed to load user data for update:', error);
                alert('Failed to load user data. Check console for details.');
            }
        }
    });

    const formUpdateUser = document.getElementById('formUpdateUser');
    formUpdateUser.addEventListener('submit', async (e) => {
        e.preventDefault();
        const userId = document.getElementById('userUpdateId').value;
        const token = localStorage.getItem('token');
        
        const payload = {
            name: document.getElementById('userUpdateName').value,
            email: document.getElementById('userUpdateEmail').value,
            role: document.getElementById('userUpdateRole').value
        };

        try {
            const response = await fetch(`${API_BASE}/users/${userId}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to update user.');
            }

            fetchUsers();
            $('#modalUpdateUser').modal('hide');
            alert('User updated successfully!');
        } catch (error) {
            console.error('Update error:', error);
            alert('Failed to update user: ' + error.message);
        }
    });

    // --- ROOM MANAGEMENT FUNCTIONS ---
    async function fetchRooms() {
        const token = localStorage.getItem('token');
        if (!token) {
            roomsList.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Authentication token not found.</td></tr>';
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/rooms`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error('Failed to fetch rooms.');
            }

            const data = await response.json();
            roomsList.innerHTML = '';
            
            if (!data || !data.data || !Array.isArray(data.data)) {
                roomsList.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Unexpected data format from API.</td></tr>`;
                return;
            }

            data.data.forEach(room => {
               const features = room.features ? room.features.map(f => f.name).join(', ') : 'None';
                const row = document.createElement('tr');
                row.innerHTML = `
                <td>${room.name || 'N/A'}</td>
                <td>${room.location || 'N/A'}</td> 
                <td>${room.capacity || 'N/A'}</td> 
                <td>${features}</td>
                <td  class="text-right d-flex flex-nowrap justify-content-end">
                    <button class="btn btn-sm btn-info  edit-room-btn"  data-id="${room.id}"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-sm btn-danger  delete-room-btn"  data-id="${room.id}"><i class="fas fa-trash-alt"></i></button>
                </td>
                `;
                roomsList.appendChild(row);
            });
        } catch (error) {
            console.error('Error fetching rooms:', error);
            roomsList.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Failed to load rooms: ${error.message}</td></tr>`;
        }
    }

    async function deleteRoom(roomId) {
        const token = localStorage.getItem('token');
        if (!confirm('Are you sure you want to delete this room?')) return;
        
        try {
            const response = await fetch(`${API_BASE}/rooms/${roomId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                alert('Room deleted successfully!');
                fetchRooms();
            } else {
                throw new Error('Failed to delete room.');
            }
        } catch (error) {
            console.error('Delete room error:', error);
            alert('Failed to delete room.');
        }
    }
    
    roomsList.addEventListener('click', async (e) => {

        if (e.target.closest('.delete-room-btn')) {

            const roomId = e.target.closest('.delete-room-btn').getAttribute('data-id');
            deleteRoom(roomId);
        } else if (e.target.closest('.edit-room-btn')) {
           const roomId = e.target.closest('.edit-room-btn').getAttribute('data-id');
           
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`${API_BASE}/rooms/${roomId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) {
                    throw new Error('Failed to fetch room data for update.');
                }
                const roomData = await response.json();

                const roomDetails = roomData.data;
                document.getElementById('roomUpdateId').value = roomDetails.id;
                document.getElementById('roomUpdateName').value = roomDetails.name;
                document.getElementById('roomUpdateLocation').value = roomDetails.location;
                document.getElementById('roomUpdateCapacity').value = roomDetails.capacity;
                const featuresArray = roomDetails.features || [];
                console.log('API returned features:', featuresArray);
                
                featuresArray.forEach(f => {
                   console.log('Feature name from API:', f.name);
                });
                document.getElementById('featureUpdateProjector').checked = featuresArray.some(f => f.name === 'Projector');
                document.getElementById('featureUpdateWhiteboard').checked = featuresArray.some(f => f.name === 'Whiteboard');
                document.getElementById('featureUpdateConference').checked = featuresArray.some(f => f.name === 'Video Conferencing');
                document.getElementById('featureUpdateWifi').checked = featuresArray.some(f => f.name === 'High-speed WiFi');

                $('#modalUpdateRoom').modal('show');

            } catch (error) {
                console.error('Failed to load room data for update:', error);
                alert('Failed to load room data. Check console for details.');
            }
        }
    });
    
    const formUpdateRoom = document.getElementById('formUpdateRoom');
    formUpdateRoom.addEventListener('submit', async (e) => {
        e.preventDefault();
         
         const roomId = parseInt(document.getElementById('roomUpdateId').value, 10);

         if (isNaN(roomId)) {
           alert('Error: Room ID is invalid. Cannot update.');
           return;
         }
        const token = localStorage.getItem('token');
        
        
          
        const payload = {
            name: document.getElementById('roomUpdateName').value,
            location: document.getElementById('roomUpdateLocation').value,
            capacity: document.getElementById('roomUpdateCapacity').value,
            features: {   

            'Projector': document.getElementById('featureUpdateProjector').checked,
            'Whiteboard': document.getElementById('featureUpdateWhiteboard').checked,
            'Video Conferencing': document.getElementById('featureUpdateConference').checked,
            'High-speed WiFi': document.getElementById('featureUpdateWifi').checked,
            },
        };
        try {
            const response = await fetch(`${API_BASE}/rooms/${roomId}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to update room.');
            }

            fetchRooms();
            $('#modalUpdateRoom').modal('hide');
            alert('Room updated successfully!');
        } catch (error) {
            console.error('Update room error:', error);
            alert('Failed to update room: ' + error.message);
        }
    });

    // --- INITIAL PAGE LOAD ---
    document.addEventListener("DOMContentLoaded", function() {
        fetchUsers();
        fetchRooms();
    });
  </script>

</body>
</html>
